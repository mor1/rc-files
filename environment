# -*- mode: sh -*-
#
# Copyright (C) 2000--2014 Richard Mortier <mort@cantab.net>.  All Rights
# Reserved.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License version 2 as
# published by the Free Software Foundation
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307,
# USA.

#
# handy shell functions
#

[ -r ~/rc-files/envfns.sh  ] && source ~/rc-files/envfns.sh
[ -r ~/rc-files/filefns.sh ] && source ~/rc-files/filefns.sh
[ -r ~/rc-files/hosts.sh   ] && source ~/rc-files/hosts.sh

[ -r ~/src/dockerfiles/dockerfns.sh ] && source ~/src/dockerfiles/dockerfns.sh

[ -r ~/src/sh-scripts/numfns.sh ] && source ~/src/sh-scripts/numfns.sh

#
# general
#

umask 0002

shopt -s checkwinsize
shopt -s extglob

PLATFORM=$(uname -s)
LHOST=$(uname -n)
SHOST=${LHOST%%.*}
KERNEL=$(uname -r)
CDPATH=.:..:../..:../../..:../../../..:../../../../..:../../../../../..:../../../../../../..:../../../../../../../..:../../../../../../../../..:../../../../../../../../../..:$HOME
EDITOR="emacsclient -s /tmp/emacs-$USER/server"
PAGER="less -FRXi"
MANPAGER="less -FRXi"

LANG="en_GB.UTF-8"
LC_ALL="C"

export LHOST SHOST KERNEL CDPATH EDITOR PAGER MANPAGER LANG LC_ALL

#
# paths
#

unset PATH
aenv PATH /sbin
aenv PATH /bin
aenv PATH /usr/sbin
aenv PATH /usr/bin
aenv PATH /usr/local/sbin
aenv PATH /usr/local/bin
aenv PATH /usr/X11R6/bin

unset MANPATH
aenv MANPATH /usr/local/share/man
aenv MANPATH /usr/share/man
aenv MANPATH /usr/X11R6/man
aenv MANPATH ~/me/local/man

#
# platform specific configuration
#

case $PLATFORM in
    Linux )
        MAKE=make

        for d in /etc/bash_completion /etc/bash_completion.d ;
        do
            ## GIT bash completion
            [ -d $d ] && (
                ( [ -r $d/git ] && source $d/git )
                ( [ -r $d/git-prompt ] && source $d/git-prompt )
            )
        done

        ## debian has ancient git completion
        [ -r ~/.git-prompt.sh ] && source ~/.git-prompt.sh
        ;;

    Darwin )
        aenv PATH /usr/local/texlive/2015/bin/x86_64-darwin

        ## homebrew completion
        # source $(brew --prefix)/Library/Contributions/brew_bash_completion.sh
        if [ -f $(brew --prefix)/etc/bash_completion ]; then
            source $(brew --prefix)/etc/bash_completion
        fi

        ## GIT bash completion
        gitdir=$(dirname $(abspath $(which git)))
        source ${gitdir}/../etc/bash_completion.d/git-completion.bash
        source ${gitdir}/../etc/bash_completion.d/git-prompt.sh

        ## Android
        export ANDROID_HOME=/usr/local/opt/android-sdk
        ;;
esac

case ${LHOST#*.} in
    cl.cam.ac.uk )
        aenv PATH /usr/kerberos/bin
esac

#
# bash settings
#

# history

command_oriented_history=TRUE # multi-line commands become single line
notify=TRUE # support notifications

shopt -s histappend # continue appending, don't delete periodically
export PROMPT_COMMAND="history -a" # add every command to history
export HISTIGNORE="&:l[sl][a]:[bf]g:exit:[ \t]"
export HISTCONTROL=ignoreboth:erasedups
export HISTSIZE=10000
export HISTFILESIZE=10000

# prompt

# so bash doesn't do variable expansion on (eg.) \w in PS1 -- consider
# the case of a dir. called "`rm -rf ~`" ... :-> (ask Austin)
export NO_PROMPT_VARS
set -o noclobber # require explicit overwrite when redirecting

source ~/rc-files/colours.sh
GIT_PS1_SHOWDIRTYSTATE=false
GIT_PS1_SHOWSTASHSTATE=false
GIT_PS1_SHOWUNTRACKEDFILES=false
GIT_PS1_SHOWCOLORHINTS=true
GIT_PS1_SHOWUPSTREAM="auto"

case $TERM in
    dumb )
        PROMPT_COMMAND='__git_ps1 \
          ": \u@\h:\[$WHITE\]\W\[$COLOR_OFF\]" \
          "\[$COLOR_OFF\]\\$; " \
          "#%s "
          '
        ;;

    * )
        PROMPT_COMMAND='__git_ps1 \
          "\[\e]0;${KERNEL} \u@\h:\w\a\]: \u@\h:\[$WHITE\]\W\[$COLOR_OFF\]" \
          "\[$COLOR_OFF\]\\$; " \
          "#%s "
          '
        ;;
esac
export PROMPT_COMMAND

# pip bash completion start
_pip_completion()
{
    COMPREPLY=( $( COMP_WORDS="${COMP_WORDS[*]}" \
                             COMP_CWORD=$COMP_CWORD \
                             PIP_AUTO_COMPLETE=1 $1 ) )
}
complete -o default -F _pip_completion pip
# pip bash completion end

## OPAM configuration
[ -f ~/.opam/opam-init/init.sh ] && \
    source ~/.opam/opam-init/init.sh > /dev/null 2> /dev/null || true
export OCAMLRUNPARAM=b
export OPAMBUILDDOC=true

## GO
export GOPATH=~/go
aenv PATH ~/go/bin

## Finally, my PATH wins:
aenv PATH ~/me/local/bin
